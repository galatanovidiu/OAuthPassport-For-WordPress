name: Create Release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        extensions: mbstring, xml, zip
        tools: composer

    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Install Node.js dependencies
      run: npm ci

    - name: Install Composer dependencies (production only)
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Build assets
      run: npm run build

    - name: Create plugin zip
      run: npm run plugin-zip

    - name: Verify zip contents
      run: |
        echo "Contents of the plugin zip file:"
        unzip -l oauth-passport.zip | head -50
        echo "..."
        echo "Total files: $(unzip -l oauth-passport.zip | tail -1)"

    - name: Create Release and Upload Asset
      uses: softprops/action-gh-release@v1
      with:
        name: OAuth Passport ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: true
        files: oauth-passport.zip
        body: |
          # OAuth Passport ${{ steps.get_version.outputs.version }}
          
          ⚠️ **EXPERIMENTAL ALPHA RELEASE** - For testing and development only. DO NOT use in production.
          
          ## What's New
          
          MCP-compliant OAuth 2.1 authorization server for WordPress.
          
          - ✅ Model Context Protocol (MCP) Authorization compliant
          - ✅ OAuth 2.1 with mandatory PKCE
          - ✅ Dynamic Client Registration (RFC 7591)
          - ✅ Authorization Server Metadata (RFC 8414)
          - ✅ Protected Resource Metadata (RFC 9728)
          - ✅ Resource Indicators (RFC 8707)
          - ✅ React Admin Interface
          
          ## Installation
          
          1. Download `oauth-passport.zip` below
          2. Upload to WordPress via Plugins > Add New > Upload Plugin
          3. Activate and configure at Settings > OAuth Passport
          
          ## Requirements
          
          - WordPress 6.4+
          - PHP 8.0+
          - HTTPS (required in production)
          - Pretty permalinks enabled
          
          ## Documentation
          
          - [Release Notes](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.tag_name }}/RELEASE_NOTES.md)
          - [Installation Guide](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.tag_name }}/README.md)
          
          ---
          
          **Remember: This is an alpha release for testing only!**

    - name: Upload to WordPress.org (optional)
      if: false # Disabled by default - enable when ready for WordPress.org
      run: |
        echo "WordPress.org deployment would go here"
        echo "You can integrate with the WordPress.org SVN repository"
        echo "or use actions like 10up/action-wordpress-plugin-deploy"